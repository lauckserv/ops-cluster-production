controllers:
  main:
    enabled: true
    type: deployment
    replicas: 1
    revisionHistoryLimit: 3
    strategy: Recreate
    containers:
      main:
        image:
          repository: ghcr.io/gitroomhq/postiz-app
          tag: latest
          pullPolicy: IfNotPresent
        env:
          # === Required Settings ===
          MAIN_URL: "https://postiz.lauckserv.com"
          FRONTEND_URL: "https://postiz.lauckserv.com"
          NEXT_PUBLIC_BACKEND_URL: "https://postiz.lauckserv.com/api"
          JWT_SECRET:
            valueFrom:
              secretKeyRef:
                name: postiz-secrets
                key: jwt-secret
          DATABASE_URL:
            valueFrom:
              secretKeyRef:
                name: postiz-secrets
                key: database-url
          REDIS_URL: "redis://redis:6379"
          BACKEND_INTERNAL_URL: "http://localhost:3000"
          IS_GENERAL: "true"
          DISABLE_REGISTRATION: "false"
          
          # === Storage Settings ===
          STORAGE_PROVIDER: "local"       # <-- TODO: UPDATE
          UPLOAD_DIRECTORY: "/uploads"
          NEXT_PUBLIC_UPLOAD_DIRECTORY: "/uploads"
          
          # === Cloudflare (R2) Settings ===
          CLOUDFLARE_ACCOUNT_ID: ""
          CLOUDFLARE_ACCESS_KEY: ""
          CLOUDFLARE_SECRET_ACCESS_KEY: ""
          CLOUDFLARE_BUCKETNAME: ""
          CLOUDFLARE_BUCKET_URL: ""
          CLOUDFLARE_REGION: "auto"
          
          # === Social Media API Settings ===
          X_API_KEY: ""
          X_API_SECRET: ""
          LINKEDIN_CLIENT_ID: ""
          LINKEDIN_CLIENT_SECRET: ""
          REDDIT_CLIENT_ID: ""
          REDDIT_CLIENT_SECRET: ""
          GITHUB_CLIENT_ID: ""
          GITHUB_CLIENT_SECRET: ""
          BEEHIIVE_API_KEY: ""
          BEEHIIVE_PUBLICATION_ID: ""
          THREADS_APP_ID: ""
          THREADS_APP_SECRET: ""
          FACEBOOK_APP_ID: ""
          FACEBOOK_APP_SECRET: ""
          YOUTUBE_CLIENT_ID: ""
          YOUTUBE_CLIENT_SECRET: ""
          TIKTOK_CLIENT_ID: ""
          TIKTOK_CLIENT_SECRET: ""
          PINTEREST_CLIENT_ID: ""
          PINTEREST_CLIENT_SECRET: ""
          DRIBBBLE_CLIENT_ID: ""
          DRIBBBLE_CLIENT_SECRET: ""
          DISCORD_CLIENT_ID: ""
          DISCORD_CLIENT_SECRET: ""
          DISCORD_BOT_TOKEN_ID: ""
          SLACK_ID: ""
          SLACK_SECRET: ""
          SLACK_SIGNING_SECRET: ""
          MASTODON_URL: "https://mastodon.social"
          MASTODON_CLIENT_ID: ""
          MASTODON_CLIENT_SECRET: ""
          
          # === OAuth & Authentik Settings ===
          NEXT_PUBLIC_POSTIZ_OAUTH_DISPLAY_NAME: "Authentik"
          NEXT_PUBLIC_POSTIZ_OAUTH_LOGO_URL: "https://raw.githubusercontent.com/walkxcode/dashboard-icons/master/png/authentik.png"
          POSTIZ_GENERIC_OAUTH: "false"
          POSTIZ_OAUTH_URL: ""
          POSTIZ_OAUTH_AUTH_URL: ""
          POSTIZ_OAUTH_TOKEN_URL: ""
          POSTIZ_OAUTH_USERINFO_URL: ""
          POSTIZ_OAUTH_CLIENT_ID: ""
          POSTIZ_OAUTH_CLIENT_SECRET: ""
          
          # === Sentry Settings ===
          NEXT_PUBLIC_SENTRY_DSN: ""
          SENTRY_SPOTLIGHT: "0"
          
          # === Misc Settings ===
          OPENAI_API_KEY: ""
          NEXT_PUBLIC_DISCORD_SUPPORT: ""
          NEXT_PUBLIC_POLOTNO: ""
          API_LIMIT: "30"
          
          # === Payment / Stripe Settings ===
          FEE_AMOUNT: "0.05"
          STRIPE_PUBLISHABLE_KEY: ""
          STRIPE_SECRET_KEY: ""
          STRIPE_SIGNING_KEY: ""
          STRIPE_SIGNING_KEY_CONNECT: ""
          
          # === Developer Settings ===
          NX_ADD_PLUGINS: "false"
          
          # === Short Link Service Settings (Optional) ===
          # DUB_TOKEN: ""
          # DUB_API_ENDPOINT: "https://api.dub.co"
          # DUB_SHORT_LINK_DOMAIN: "dub.sh"
          # SHORT_IO_SECRET_KEY: ""
          # KUTT_API_KEY: ""
          # KUTT_API_ENDPOINT: "https://kutt.it/api/v2"
          # KUTT_SHORT_LINK_DOMAIN: "kutt.it"
          # LINK_DRIP_API_KEY: ""
          # LINK_DRIP_API_ENDPOINT: "https://api.linkdrip.com/v1/"
          # LINK_DRIP_SHORT_LINK_DOMAIN: "dripl.ink"
        
        probes:
          liveness:
            enabled: true
            type: HTTP
            path: /api/health
            custom: false
            spec:
              initialDelaySeconds: 30
              periodSeconds: 30
              timeoutSeconds: 5
              failureThreshold: 3
          readiness:
            enabled: true
            type: HTTP
            path: /api/health
            custom: false
            spec:
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 3
          startup:
            enabled: true
            type: HTTP
            path: /api/health
            custom: false
            spec:
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 5
              failureThreshold: 30
        
        strategy:
          type: Recreate
    
    initContainers:
      wait-for-postgres:
        image:
          repository: busybox
          tag: latest
        command:
          - sh
          - -c
          - |
            until nc -z postiz-postgres 5432; do
              echo "Waiting for PostgreSQL..."
              sleep 2
            done
      wait-for-redis:
        image:
          repository: busybox
          tag: latest
        command:
          - sh
          - -c
          - |
            until nc -z postiz-redis 6379; do
              echo "Waiting for Redis..."
              sleep 2
            done

  postgres:
    enabled: true
    type: deployment
    replicas: 1
    strategy: Recreate
    containers:
      main:
        image:
          repository: postgres
          tag: 17-alpine
          pullPolicy: IfNotPresent
        env:
          POSTGRES_PASSWORD:
            valueFrom:
              secretKeyRef:
                name: postiz-secrets
                key: postgres-password
          POSTGRES_USER: postiz-user
          POSTGRES_DB: postiz-db-local

  redis:
    enabled: true
    type: deployment
    replicas: 1
    strategy: Recreate
    containers:
      main:
        image:
          repository: redis
          tag: "7.2"
          pullPolicy: IfNotPresent
        probes:
          liveness:
            enabled: true
            type: exec
            custom: true
            spec:
              exec:
                command:
                  - redis-cli
                  - ping
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 3
              failureThreshold: 3
          readiness:
            enabled: true
            type: exec
            custom: true
            spec:
              exec:
                command:
                  - redis-cli
                  - ping
              initialDelaySeconds: 10
              periodSeconds: 10
              timeoutSeconds: 3
              failureThreshold: 3

  spotlight:
    enabled: false
    type: deployment
    replicas: 1
    containers:
      main:
        image:
          repository: ghcr.io/getsentry/spotlight
          tag: latest
          pullPolicy: Always

service:
  main:
    controller: main
    type: ClusterIP
    primary: true
    ports:
      http:
        enabled: true
        primary: true
        port: 5000
  
  postgres:
    controller: postgres
    type: ClusterIP
    ports:
      postgres:
        enabled: true
        port: 5432
  
  redis:
    controller: redis
    type: ClusterIP
    ports:
      redis:
        enabled: true
        port: 6379
  
  spotlight:
    controller: spotlight
    enabled: false
    type: ClusterIP
    ports:
      http:
        enabled: true
        port: 8969

ingress:
  main:
    enabled: true
    className: nginx
    annotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/proxy-body-size: 500M
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    hosts:
      - host: postiz.lauckserv.com
        paths:
          - path: /
            pathType: Prefix
            service:
              identifier: main
              port: http

persistence:
  config:
    enabled: true
    type: persistentVolumeClaim
    storageClass: nfs-client
    accessMode: ReadWriteMany
    size: 1Gi
    globalMounts:
      - path: /config/
        readOnly: false
  
  uploads:
    enabled: true
    type: persistentVolumeClaim
    storageClass: nfs-client
    accessMode: ReadWriteMany
    size: 5Gi
    globalMounts:
      - path: /uploads/
        readOnly: false
  
  postgres-data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: nfs-client
    accessMode: ReadWriteOnce
    size: 10Gi
    advancedMounts:
      postgres:
        main:
          - path: /var/lib/postgresql/data
            readOnly: false

  redis-data:
    enabled: true
    type: persistentVolumeClaim
    storageClass: nfs-client
    accessMode: ReadWriteOnce
    size: 1Gi
    advancedMounts:
      redis:
        main:
          - path: /data
            readOnly: false
